<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Free Image Compressor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: light;
        --bg: #f5f7fb;
        --card: #ffffff;
        --border-soft: #e5e7eb;
        --text-main: #0f172a;
        --text-muted: #6b7280;
        --accent: #111827;
        --accent-soft: #020617;
        --accent-text: #f9fafb;
        --shadow-soft: 0 24px 60px rgba(15, 23, 42, 0.12);
        --radius-xl: 28px;
        --accent-blue: #2563eb;
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          sans-serif;
        background: radial-gradient(circle at top left, #e0ecff 0, #f5f7fb 38%, #f5f7fb 100%);
        color: var(--text-main);
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 24px;
      }

      .shell {
        width: 100%;
        max-width: 1120px;
      }

      .title-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 18px;
        padding: 4px 6px;
      }

      .app-title {
        font-size: 18px;
        font-weight: 600;
        letter-spacing: 0.02em;
      }

      .pill {
        font-size: 11px;
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.05);
        color: var(--text-muted);
      }

      .layout {
        display: grid;
        grid-template-columns: minmax(0, 320px) minmax(0, 1.4fr);
        gap: 28px;
        align-items: stretch;
      }

      @media (max-width: 900px) {
        body {
          align-items: flex-start;
        }
        .layout {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .panel {
        background: var(--card);
        border-radius: var(--radius-xl);
        border: 1px solid rgba(148, 163, 184, 0.18);
        padding: 20px 20px 22px;
        box-shadow: 0 18px 40px rgba(148, 163, 184, 0.25);
      }

      .panel h2 {
        margin: 0 0 4px;
        font-size: 15px;
        font-weight: 600;
      }

      .panel-sub {
        margin: 0 0 16px;
        font-size: 12px;
        color: var(--text-muted);
      }

      .field {
        border-radius: 18px;
        border: 1px solid var(--border-soft);
        padding: 10px 14px;
        background: #f9fafb;
        margin-bottom: 14px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .field-label {
        font-size: 11px;
        color: var(--text-muted);
      }

      .field-value {
        font-size: 13px;
        font-weight: 500;
      }

      .slider-label-row {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 4px;
      }

      .slider-main-label {
        font-size: 12px;
        font-weight: 500;
      }

      .slider-badge {
        font-size: 11px;
        color: var(--text-muted);
      }

      input[type="range"] {
        width: 100%;
        accent-color: var(--accent-blue);
      }

      .slider-caption-row {
        display: flex;
        justify-content: space-between;
        margin-top: 4px;
        font-size: 11px;
        color: var(--text-muted);
      }

      .summary {
        margin-top: 18px;
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        gap: 12px;
        font-size: 11px;
        color: var(--text-muted);
      }

      .summary-main {
        font-size: 13px;
        color: var(--text-main);
        font-weight: 500;
      }

      .summary-nums {
        text-align: right;
      }

      .summary-nums strong {
        display: block;
        font-size: 16px;
        font-weight: 600;
        color: var(--text-main);
      }

      .summary-nums span {
        text-decoration: line-through;
      }

      .primary-btn {
        margin-top: 16px;
        width: 100%;
        border-radius: 999px;
        border: none;
        padding: 12px 18px;
        background: linear-gradient(135deg, var(--accent-soft), var(--accent));
        color: var(--accent-text);
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        cursor: pointer;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.5);
        transition: transform 0.05s ease, box-shadow 0.05s ease, opacity 0.1s ease;
      }

      .primary-btn:not(:disabled):active {
        transform: translateY(1px);
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.4);
      }

      .primary-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        box-shadow: none;
      }

      .primary-btn-arrow {
        font-size: 14px;
        transform: translateX(1px);
      }

      .status-text {
        margin-top: 6px;
        font-size: 11px;
        color: var(--text-muted);
        cursor: pointer;
        text-decoration: underline;
        text-underline-offset: 2px;
      }

      .status-text:hover {
        color: #4b5563;
      }

      .preview-card {
        background: radial-gradient(circle at top, #fef9f4 0, #fdfcfb 40%, #f9fafb 100%);
        border-radius: var(--radius-xl);
        border: 1px solid rgba(226, 232, 240, 0.9);
        padding: 18px 20px 18px;
        box-shadow: var(--shadow-soft);
        display: flex;
        flex-direction: column;
        gap: 14px;
        min-height: 420px;
      }

      .preview-frame {
        position: relative;
        background: #e5e7eb;
        border-radius: 24px;
        overflow: hidden;
        height: 360px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px dashed transparent;
        transition: border-color 0.12s ease, background-color 0.12s ease;
      }

      @media (max-width: 900px) {
        .preview-frame {
          height: 300px;
        }
      }

      .preview-frame.drag-over {
        border-color: var(--accent-blue);
        background-color: rgba(191, 219, 254, 0.3);
      }

      .preview-placeholder {
        text-align: center;
        color: var(--text-muted);
        font-size: 13px;
        pointer-events: none;
      }

      .preview-placeholder strong {
        display: block;
        margin-bottom: 4px;
        font-size: 14px;
        color: var(--text-main);
      }

      canvas {
        max-width: 100%;
        max-height: 100%;
        width: auto;
        height: auto;
        display: block;
      }

      .hidden {
        display: none !important;
      }

      @media (max-width: 600px) {
        .panel,
        .preview-card {
          border-radius: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <div class="title-row">
        <div class="app-title">Compression Options</div>
        <div class="pill">Free Image Compressor</div>
      </div>

      <div class="layout">
        <!-- LEFT: controls -->
        <section class="panel" aria-label="Compression settings">
          <h2>Settings</h2>
          <p class="panel-sub">Upload a photo, adjust quality, and download a smaller file.</p>

          <div class="field">
            <div class="field-label">Resolution</div>
            <div class="field-value" id="resolution-label">Waiting for image…</div>
          </div>

          <div class="field">
            <div class="slider-label-row">
              <div class="slider-main-label">Image quality</div>
              <div class="slider-badge" id="quality-label">Balanced</div>
            </div>
            <input id="quality" type="range" min="40" max="95" value="80" />
            <div class="slider-caption-row">
              <span>Smaller file</span>
              <span>Better quality</span>
            </div>
          </div>

          <div class="summary">
            <div>
              <div class="summary-main">Compressed size</div>
              <div id="summary-note">Drop an image to see the result.</div>
            </div>
            <div class="summary-nums">
              <strong id="size-estimate">– MB</strong>
              <span id="size-original">– MB</span>
            </div>
          </div>

          <button id="compress-btn" class="primary-btn" disabled>
            <span id="compress-btn-label">Download compressed file</span>
            <span class="primary-btn-arrow">➜</span>
          </button>
          <div id="status-text" class="status-text">
            Click here to choose an image to get started.
          </div>
        </section>

        <!-- RIGHT: preview box only -->
        <section class="preview-card" aria-label="Preview and drop zone">
          <div class="preview-frame" id="drop-zone">
            <input
              id="file-input"
              type="file"
              accept="image/*"
              class="hidden"
            />
            <div id="placeholder" class="preview-placeholder">
              <strong>Drop your image here</strong>
              <span>or click this area to browse a file (max 10MB).</span>
            </div>
            <canvas id="preview-canvas" class="hidden"></canvas>
          </div>
        </section>
      </div>
    </div>

    <script>
      (function () {
        const API_BASE = "https://free-image-compressor-backend.onrender.com";

        const fileInput = document.getElementById("file-input");
        const dropZone = document.getElementById("drop-zone");
        const placeholder = document.getElementById("placeholder");
        const canvas = document.getElementById("preview-canvas");
        const ctx = canvas.getContext("2d");

        const resolutionLabel = document.getElementById("resolution-label");

        const qualityInput = document.getElementById("quality");
        const qualityLabel = document.getElementById("quality-label");
        const summaryNote = document.getElementById("summary-note");
        const sizeEstimate = document.getElementById("size-estimate");
        const sizeOriginal = document.getElementById("size-original");

        const compressBtn = document.getElementById("compress-btn");
        const compressBtnLabel = document.getElementById("compress-btn-label");
        const statusText = document.getElementById("status-text");

        let currentFile = null;

        function formatMB(bytes) {
          return (bytes / (1024 * 1024)).toFixed(2) + " MB";
        }

        function describeQuality(value) {
          const v = Number(value);
          if (v <= 55) return "Smaller file";
          if (v <= 80) return "Balanced";
          return "High quality";
        }

        function updateQualityLabelAndEstimate() {
          qualityLabel.textContent = describeQuality(qualityInput.value);

          if (!currentFile) return;
          const q = Number(qualityInput.value) / 100;
          const approximate = Math.max(currentFile.size * q, currentFile.size * 0.25);
          sizeEstimate.textContent = formatMB(approximate);
          sizeOriginal.textContent = formatMB(currentFile.size);
          summaryNote.textContent =
            "Approximate size based on quality. Higher quality = larger file.";
        }

        qualityInput.addEventListener("input", updateQualityLabelAndEstimate);

        function resetStats() {
          sizeEstimate.textContent = "– MB";
          sizeOriginal.textContent = "– MB";
          summaryNote.textContent = "Drop an image to see the result.";
        }

        function setFile(file) {
          currentFile = file;
          if (!file) {
            canvas.classList.add("hidden");
            placeholder.classList.remove("hidden");
            compressBtn.disabled = true;
            resolutionLabel.textContent = "Waiting for image…";
            resetStats();
            statusText.textContent = "Click here to choose an image to get started.";
            return;
          }

          if (file.size > 10 * 1024 * 1024) {
            alert("Please choose a file smaller than 10MB.");
            setFile(null);
            return;
          }

          compressBtn.disabled = false;
          sizeOriginal.textContent = formatMB(file.size);
          sizeEstimate.textContent = "– MB";
          summaryNote.textContent = "Move the slider, then download the compressed file.";
          statusText.textContent = "Click here if you want to pick a different image.";

          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const maxWidth = 960;
              const scale = img.width > maxWidth ? maxWidth / img.width : 1;
              canvas.width = img.width * scale;
              canvas.height = img.height * scale;
              ctx.clearRect(0, 0, canvas.width, canvas.height);
              ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

              placeholder.classList.add("hidden");
              canvas.classList.remove("hidden");

              resolutionLabel.textContent =
                Math.round(img.width) + " × " + Math.round(img.height);
              updateQualityLabelAndEstimate();
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        }

        // Status text opens file picker
        statusText.addEventListener("click", () => fileInput.click());

        // Drag & drop
        dropZone.addEventListener("click", () => fileInput.click());
        fileInput.addEventListener("change", (e) => {
          const f = e.target.files[0];
          if (f) setFile(f);
        });

        dropZone.addEventListener("dragover", (e) => {
          e.preventDefault();
          dropZone.classList.add("drag-over");
        });

        ["dragleave", "dragend"].forEach((evt) => {
          dropZone.addEventListener(evt, () => {
            dropZone.classList.remove("drag-over");
          });
        });

        dropZone.addEventListener("drop", (e) => {
          e.preventDefault();
          dropZone.classList.remove("drag-over");
          const f = e.dataTransfer.files[0];
          if (f) setFile(f);
        });

        function updateStatsAndDownload(blob, originalSize, note) {
          const compressedSize = blob.size;
          const saved = originalSize - compressedSize;
          const pct =
            originalSize > 0 ? Math.round((saved / originalSize) * 100) : 0;

          sizeEstimate.textContent = formatMB(compressedSize);
          sizeOriginal.textContent = formatMB(originalSize);

          if (note) {
            summaryNote.textContent = note;
          } else if (saved > 0) {
            summaryNote.textContent = "Saved " + pct + "% compared to the original.";
          } else {
            summaryNote.textContent =
              "Image was already optimized; size changed by " + pct + "%.";
          }

          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          const name =
            "compressed-" +
            (currentFile.name.replace(/\.[^.]+$/, "") || "image") +
            ".jpg";
          a.href = url;
          a.download = name;
          a.click();
          URL.revokeObjectURL(url);
        }

        compressBtn.addEventListener("click", async () => {
          if (!currentFile) return;

          compressBtn.disabled = true;
          compressBtnLabel.textContent = "Compressing…";
          statusText.textContent = "Sending your image to the server…";

          try {
            const form = new FormData();
            form.append("file", currentFile);
            form.append("quality", qualityInput.value);
            form.append("format", "jpeg");
            form.append("maxWidth", "1920");

            const res = await fetch(
              API_BASE + "/api/images/compress",
              { method: "POST", body: form }
            );

            if (!res.ok) {
              throw new Error("Server error");
            }

            const blob = await res.blob();
            const originalSize = currentFile.size;
            const note =
              res.headers.get("X-Compression-Note") ||
              "";

            updateStatsAndDownload(blob, originalSize, note);
            statusText.textContent =
              "Done! Click here to choose another image.";
          } catch (err) {
            console.error(err);
            alert("Compression failed. Please try again.");
            statusText.textContent =
              "Something went wrong. Click here to try again.";
          } finally {
            compressBtn.disabled = false;
            compressBtnLabel.textContent = "Download compressed file";
          }
        });

        // Initial labels
        updateQualityLabelAndEstimate();
      })();
    </script>
  </body>
</html>
